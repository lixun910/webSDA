<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Test GeoJSON file</title>
<style>
.canvas {
    stroke: #000;
}
path {
    fill: green;
    stroke: #000;
    stroke-linejoin: round;
}
.boundary {
    pointer-events: none;
    fill: none;
    stroke: #fff;
    stroke-width: .5px;
    stroke-linejoin: round;
}
.selected {
    fill: yellow;
}
.unselected {
    fill: green;
}
</style>
<script src="jquery.min.js"></script>
<script src="d3.v3.min.js"></script>
<script src="utils.js"></script>
<script type="text/javascript" src="https://www.dropbox.com/static/api/2/dropins.js" id="dropboxjs" data-app-key="50dk6qp6nc2fcxs"></script>
<script type="text/javascript">
 	
///////////////////////////////////////////////////////////////
// Show map function
///////////////////////////////////////////////////////////////
var data; // global for testing
var w = 900;
var h = 600;
function ShowJsonMap(jsonFilePath) {
    //Create SVG element
    var svg = d3.select("body")
        .append("svg")
        .attr("width", w)
        .attr("height", h)
        .attr("class", "canvas");


    //Load in GeoJSON data
    var createJsonMap = function(json) {
        console.log(json);
        if (localStorage.getItem(jsonFilePath) == null) {
            localStorage.setItem(jsonFilePath, JSON.stringify(json));
        }

        var minX = Number.POSITIVE_INFINITY,
            maxX = Number.NEGATIVE_INFINITY,
            minY = Number.POSITIVE_INFINITY,
            maxY = Number.NEGATIVE_INFINITY;
        data = json;
        json.features.forEach(function(feat,i) {
            feat.geometry.coordinates.forEach(function(coords,j) {
                coords.forEach(function(xy,k){
                    x = xy[0], y = xy[1];
                    if (x > maxX) {maxX = x;}
                    if (x < minX) {minX = x;}
                    if (y > maxY) {maxY = y;}
                    if (y < minY) {minY = y;}
                });
            });
        });

        console.log(minX,maxX,minY,maxY);
        var xyratio = (maxX-minX)/(maxY-minY);
        var offsetW = 0.0;
        var offsetH = 0.0;
        if (w/h > xyratio) {
            // canvas is too wide
            offsetW = (w - h*xyratio)/2.0;
        } else if (w/h < xyratio) {
            // canvas is too tall
            offsetH = (h - w/xyratio)/2.0;
        }

        var scaleX = d3.scale.linear()
            .domain([minX,maxX])
            .range([0, w-offsetW*2]);
        scaleY = d3.scale.linear()
            .domain([minY, maxY])
            .range([h-offsetH*2,0]);

        function matrix(a, b, c, d, tx, ty) {
            return d3.geo.transform({
                point: function(x, y) { 
                    this.stream.point(scaleX(x)+offsetW, scaleY(y)+offsetH); 
                }});
        }
        var path = d3.geo.path().projection(matrix(-1, 0, 0, 1, 0, 0));
        var polys = svg.append("g")
            .selectAll("path")
            .data(json.features)
            .enter().append("path")
            .attr("id", function(d,i){ return i;}) 
            .attr("d", path);

        polys.append("title")
            .text(function(d,i){return i;});

        polys 
            .each(function(d,i){})
            .on("mouseover", function(d){
                d3.select(this).attr("class", "selected");
                console.log(this.id);
                var msg = {'SELECTED':[d.properties.FIPS]};
                socket.send(JSON.stringify(msg));
            })
            .on("mouseout", function(d){
                d3.select(this).attr("class", "unselected"); 
                var msg = {'SELECTED':[]};
                socket.send(JSON.stringify(msg));
            });
    };

    console.log("load from raw data");
    d3.json(jsonFilePath, createJsonMap);
        //console.log("load from cache", json);
        //jsonContent = JSON.localStorage.getItem(jsonFilePath);
        //json = JSON.parse(jsonContent);
        //createJsonMap(json);
} // end function ShowJsonMap()


var socket;
var db;

///////////////////////////////////////////////////////////////
// Init document 
///////////////////////////////////////////////////////////////
$(document).ready(function() {

    //var jsonname = getParameterByName("json");
    //if (!jsonname) {
    //    return;
    //}
    var pageid = guid(); 
    
    //////////////////////////////////////////////////////////////
    // cache filesystem 
    //////////////////////////////////////////////////////////////
    var resourceURL;
    var resourceDIRLOC = "resources";
    var fileSystem;
    var resourceDIR;

    function errorHandler(e) {
      var msg = '';
  console.dir(e);
      switch (e.code) {
	case FileError.QUOTA_EXCEEDED_ERR:
	  msg = 'QUOTA_EXCEEDED_ERR';
	  break;
	case FileError.NOT_FOUND_ERR:
	  msg = 'NOT_FOUND_ERR';
	  break;
	case FileError.SECURITY_ERR:
	  msg = 'SECURITY_ERR';
	  break;
	case FileError.INVALID_MODIFICATION_ERR:
	  msg = 'INVALID_MODIFICATION_ERR';
	  break;
	case FileError.INVALID_STATE_ERR:
	  msg = 'INVALID_STATE_ERR';
	  break;
	default:
	  msg = 'Unknown Error';
	  break;
      };

      console.log('Error: ' + msg);
    }

    function fetchResource() {
        console.log(resourceURL);
	    var xhr = new XMLHttpRequest();
	    xhr.responseType="text/plain";
	    xhr.open("GET", resourceURL,true);
	    xhr.onload = function(e) {
		    if(this.status == 200) {
			    var content = this.response;
			    resourceDIR.getFile("nat.json", {create:true}, function(file) {
                    file.createWriter(function(fileWriter) {
                        fileWriter.onwriteend = function(e) {
                            console.log('Write completed.');

                resourceDIR.getFile("nat.json", {create:false}, function(fileEntry) {
                    // Get a File object representing the file,
                    // then use FileReader to read its contents.
                    fileEntry.file(function(file) {
                        var reader = new FileReader();

                        reader.onloadend = function(e) {
                            console.log(this.result);

                        };

                        reader.readAsText(file);
                    }, errorHandler);
                });


                          };

                          fileWriter.onerror = function(e) {
                            console.log('Write failed: ' + e.toString());
                          };
                        var blob = new Blob([content], {type: "text/plain"});
                        fileWriter.write(blob);
                    });
				    console.log("Yes, I opened "+file.fullPath);
                    localStorage[file] = 1
	                resourceDIR.getFile("nat.json", {create:false}, function(file) {
                        console.log("In success handler for "+file.name + " " + file.toURL());
          		        ShowJsonMap(file.toURL());
		            });
			    });

		    }
	    }
	    xhr.send();
    }

    function localCache(url) {
	    resourceURL = url;
         if(!window.webkitStorageInfo) return;

	    window.webkitStorageInfo.requestQuota(window.PERSISTENT, 100*1024*1024, function(grantedBytes) {
		    console.log("I was granted "+grantedBytes+" bytes.");
		    window.webkitRequestFileSystem(window.PERSISTENT, grantedBytes, onInitFs, errorHandler);
	    }, errorHandler);

	    function onInitFs(fs) {
		    fileSystem = fs;

		    fileSystem.root.getDirectory(fs.root.fullPath + '/' + resourceDIRLOC, {create:true}, function(dir) {
			    resourceDIR = dir;
				fetchResource();
		    },errorHandler);
	    }
    }

    //////////////////////////////////////////////////////////////
    // WebSocket Server Communications
    //////////////////////////////////////////////////////////////
    // create websocket
    if (! ("WebSocket" in window)) WebSocket = MozWebSocket; // firefox
    socket = new WebSocket("ws://localhost:9000");

    // open the socket
    socket.onopen = function(event) {
        socket.send('{connected:'+ pageid + '}');

        // show server response
        socket.onmessage = function(e) {
            // handle different messages
            try {
            data = JSON.parse(e.data);
            if ( 'SELECTED' in data ) {
                select_ids = data['SELECTED'];
                d3.selectAll("path")
                    .attr("class", "unselected");
                d3.selectAll("path")
                    .each(function(d,i){ 
                        if (jQuery.inArray(d.properties.FIPS, select_ids) > -1) {
                            //if (d.id in select_ids) {
                            d3.select(this).attr("class", "selected");
                        }
                    });
            }
            } catch (err) {
                console.error("Parsing error:", err);            
            }
        }
    }

    //////////////////////////////////////////////////////////////
    // Dropbox Plugin
    //////////////////////////////////////////////////////////////
    var dropboxOptions = {

        // Required. Called when a user selects an item in the Chooser.
        success: function(files) {
            //alert("Here's the file link: " + files[0].link)
            //ShowJsonMap(files[0].link);
    		localCache(files[0].link);
	       //resourceDIR.getFile("nat.json", {create:false}, function(file) {
           //         console.log("In success handler for "+file.name + " " + file.toURL());
		   //     ShowJsonMap(file.toURL());
		   //});
        },

        // Optional. Called when the user closes the dialog without selecting a file
        // and does not include any parameters.
        cancel: function() {
            $('#progressCont').hide();
        },

        // Optional. "preview" (default) is a preview link to the document for sharing,
        // "direct" is an expiring link to download the contents of the file. For more
        // information about link types, see Link types below.
        linkType: "direct", // or "direct"

        // Optional. A value of false (default) limits selection to a single file, while
        // true enables multiple file selection.
        multiselect: false, // or true

        // Optional. This is a list of file extensions. If specified, the user will
        // only be able to select files with these extensions. You may also specify
        // file types, such as "video" or "images" in the list. For more information,
        // see File types below. By default, all extensions are allowed.
        extensions: ['.json', '.geojson'],
    };

    var button = Dropbox.createChooseButton(dropboxOptions);
    document.getElementById("dropboxCont").appendChild(button);

    $('#progressCont').hide();
    $('#dropboxCont').click(function() {
        $('#progressCont').show();
    });
});


//localStorage.selectedid = [1,2];
</script>
</head>
<body>
<div id="dropboxCont"></div>
<div id="progressCont">Loading data from Dropbox ...</div>
</body>
</html>
