<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Test GeoJSON file</title>
<style>
path {
    fill: green;
    stroke: #000;
    stroke-linejoin: round;
}
.boundary {
    pointer-events: none;
    fill: none;
    stroke: #fff;
    stroke-width: .5px;
    stroke-linejoin: round;
}
.selected {
    fill: yellow;
}
.unselected {
    fill: green;
}
</style>
<script src="jquery.min.js"></script>
<script src="d3.v3.min.js"></script>
<script src="utils.js"></script>
<script type="text/javascript">
//////////////////////////////////////////////////////////////
// WebSocket Server Communications
var socket;
//Width and height
var w = 960;
var h = 500;

var data; // global for testing

//$(document).ready(function() {
window.onload = function(){
    var pageid = guid(); 
    // create websocket
    if (! ("WebSocket" in window)) WebSocket = MozWebSocket; // firefox
    socket = new WebSocket("ws://localhost:9000");

    // open the socket
    socket.onopen = function(event) {
        socket.send('{connected:'+ pageid + '}');

        // show server response
        socket.onmessage = function(e) {
            // handle different messages
            try {
            data = JSON.parse(e.data);
            if ( 'SELECTED' in data ) {
                select_ids = data['SELECTED'];
                d3.selectAll("path")
                    .attr("class", "unselected");
                d3.selectAll("path")
                    .each(function(d,i){ 
                        if (jQuery.inArray(d.properties.FIPS, select_ids) > -1) {
                            //if (d.id in select_ids) {
                            d3.select(this).attr("class", "selected");
                        }
                    });
            }
            } catch (err) {
                console.error("Parsing error:", err);            
            }
        }
    }

    //Create SVG element
    var svg = d3.select("body")
        .append("svg")
        .attr("width", w)
        .attr("height", h);


    //Load in GeoJSON data
    d3.json("http://127.0.0.1:8000/nat.json", function(json) {
        var minX = Number.POSITIVE_INFINITY,
            maxX = Number.NEGATIVE_INFINITY,
            minY = Number.POSITIVE_INFINITY,
            maxY = Number.NEGATIVE_INFINITY;
        data = json;
        json.features.forEach(function(feat,i) {
            feat.geometry.coordinates.forEach(function(coords,j) {
                coords.forEach(function(xy,k){
                    x = xy[0], y = xy[1];
                    if (x > maxX) {maxX = x;}
                    if (x < minX) {minX = x;}
                    if (y > maxY) {maxY = y;}
                    if (y < minY) {minY = y;}
                });
            });
        });

    console.log(minX,maxX,minY,maxY);
    var scaleX = d3.scale.linear()
        .domain([minX,maxX])
        .range([0, w]);
    scaleY = d3.scale.linear()
        .domain([minY, maxY])
        .range([h,0]);

    function matrix(a, b, c, d, tx, ty) {
        return d3.geo.transform({
            point: function(x, y) { 
                this.stream.point( scaleX(x), scaleY(y)); 
            }});
    }
    var path = d3.geo.path().projection(matrix(-1, 0, 0, 1, 0, 0));
    var polys = svg.append("g")
        .selectAll("path")
        .data(json.features)
        .enter().append("path")
        .attr("id", function(d){ d.properties.FIPS;}) 
        .attr("d", path);

    polys.append("title")
        .text(function(d){return d.properties.FIPS;});

    polys 
        .each(function(d,i){})
        .on("mouseover", function(d){
            d3.select(this).attr("class", "selected");
            var msg = {'SELECTED':[d.properties.FIPS]};
            socket.send(JSON.stringify(msg));
        })
        .on("mouseout", function(d){
            d3.select(this).attr("class", "unselected"); 
            var msg = {'SELECTED':[]};
            socket.send(JSON.stringify(msg));
        });
    });
//});
}

//localStorage.selectedid = [1,2];
</script>
</head>
<body>
</body>
</html>
